
open Fourever

let competition_name event competition =
  if Competition.name competition = "" then
    Event.name event
  else
    Format.asprintf "%s - %s"
      (Event.name event) (Competition.name competition)

let divisions dancer =
  match Dancer.as_leader dancer, Dancer.as_follower dancer with
  | dl, df when Division.equal dl df -> Badge.division dl
  | Novice, df -> Badge.division ~role:Follower df
  | dl, Novice -> Badge.division ~role:Leader dl
  | dl, df ->
    Format.asprintf "%s %s"
      (Badge.division ~role:Leader dl)
      (Badge.division ~role:Follower df)


(* ************************************************************************* *)
(* Individual Dancer profile *********************************************** *)
(* ************************************************************************* *)

let t st id =
  let dancer = Dancer.get st id in

  <div class="row">
    <h2>
      <%s Dancer.first_name dancer%>, <%s Dancer.last_name dancer %>
      <%s! divisions dancer %>
    </h2>
  </div>
  <div class="row">
% let m =
%   Results.get_where_dancer st id
%   |> Results.order_map st
%   |> Id.Map.find id
% in
% let comp, non_comp =
%   Category.Map.partition (fun cat _ -> Category.competitive cat) m
% in
% ["Competitive", comp; "Non-competitive", non_comp]
% |> List.iter begin fun (title, map) ->
% if not (Category.Map.is_empty map) then begin
  <div class="col">
    <h3><%s title %></h3>
    <table class="table table-hover table-striped">
      <thead>
        <tr class="table-dark">
          <th scope="col"></th>
          <th scope="col">Competition</th>
          <th scope="col">Date</th>
          <th scope="col">Kind</th>
          <th scope="col">Result</th>
          <th scope="col">Points</th>
        </tr>
      </thead>
      <tbody>
% map |> Category.Map.iter begin fun cat map ->
        <tr class="table-secondary text-center">
          <td colspan="6">
            <strong><%s Category.to_string cat %></strong>
          </td>
        </tr>
% map |> Date.Map.to_rev_seq |> Seq.iter begin fun (_, l) ->
% l |> List.iter begin fun (result, competition, event) ->
        <tr class="table-primary">
          <th scope="row">
            <%s Role.short (Results.role result) %>
          </th>
          <th scope="row">
            <%s! Links.comp ~kind:"secondary" competition
                   (competition_name event competition) %>
          </th>
          <th>
            <%s Date.to_string (Event.date event) %>
          </th>
          <th>
            <%s Kind.to_string (Competition.kind competition) %>
          </th>
          <th>
            <%s Rank.to_string (Results.rank result) %>
          </th>
          <th>
            <%s string_of_int (Results.points result) %>
          </th>
        </tr>
% end;
% end;
% end;
      </tbody>
    </table>
  </div>
% end;
% end;
  </div>


(* ************************************************************************* *)
(* List of all Dancers ***************************************************** *)
(* ************************************************************************* *)

let list st =

  <div class="row justify-content-center"><div class="col-6">
  <h1>Dancer list</h1>
  <table id="dancers" class="table table-hover table-striped m-3">
    <thead>
      <tr>
        <th scope="col">Name</th>
        <th scope="col">Category</th>
      </tr>
    </thead>
    <tbody>
%   Dancer.list st |> List.iter begin fun dancer ->
      <tr>
        <th scope="row">
          <%s! Links.dancer dancer (Dancer.full_name dancer) %>
        </td>
        <td>
          <div><%s! divisions dancer %></div>
        </td>
      </tr>
%   end;
    </tbody>
  </table>
  </div></div>
