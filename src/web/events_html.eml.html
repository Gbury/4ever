
open Fourever

let t st id =
  let event = Event.get st id in

  <h1><%s Event.name event %></h1>
  <p>
    <%s Date.month_name @@ Date.month @@ Event.date event %> -
    <%s string_of_int @@ Date.year @@ Event.date event %>
  <p>

  <p>TODO: add some description of events ?</p>

  <div class="container">
% Competition.get_where_event st id
% |> Competition.order_map
% |> Kind.Map.iter begin fun kind map ->
    <div class="row">
      <h2><%s Kind.to_string kind %></h2>
% map |> Division.Map.iter begin fun div comp ->
      <div class="col">
        <h3><%s Division.to_string div %></h3>
        <table class="table">
          <thead>
            <tr>
              <th scope="col">First Name</th>
              <th scope="col">Last Name</th>
              <th scope="col">Rank</th>
            </tr>
          </thead>
          <tbody>
% State.query_all_where ~p:Id.p ~conv:Results.conv ~st
% {| SELECT * FROM results WHERE competition=? ORDER BY rank ASC LIMIT 3 |}
% (Competition.id comp) ~f:begin fun result ->
% let dancer = Dancer.get st (Results.dancer result) in
            <tr>
              <th>
                <%s Dancer.first_name dancer %>
              </th>
              <th>
                <%s Dancer.last_name dancer %>
              </th>
              <th>
                <%s Rank.to_string (Results.rank result) %>
              </th>
            </tr>
% end;
          </tbody>
        </table>
      </div>
% end;
    </div>
% end;
  </div>


let list event_list =

  <h1>Event list</h1>
  <table class="table table-striped my-3">
    <thead>
      <tr>
        <th scope="col">Event Name</th>
        <th scope="col">Month</th>
        <th scope="col">Year</th>
      </tr>
    </thead>
    <tbody>
%   event_list |> List.iter begin fun event ->
      <tr>
        <th scope="row">
          <a class="link-primary" href="/event/<%s string_of_int (Fourever.Event.id event) %>">
            <%s Event.name event %>
          </a>
        </th>
        <td><%s Date.month_name @@ Date.month @@ Event.date event %></td>
        <td><%s string_of_int @@ Date.year @@ Event.date event %></td>
      </tr>
%   end;
    </tbody>
  </table>

