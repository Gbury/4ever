
open Fourever

let t st id =
  let event = Event.get st id in

  <h1><%s Event.name event %></h1>
  <h3>
    <%s string_of_int @@ Date.day @@ Event.date event %>
    <%s Date.month_name @@ Date.month @@ Event.date event %> -
    <%s string_of_int @@ Date.year @@ Event.date event %>
  </h3>

  <p>TODO: add some description of events ?</p>

  <div class="container">
% Competition.get_where_event st id
% |> Competition.order_map
% |> Kind.Map.iter begin fun kind map ->
    <div class="row">
      <h2><%s Kind.to_string kind %></h2>
% map |> Division.Map.iter begin fun div l ->
% l |> List.iter begin fun comp ->
      <div class="col">
        <h3>
% if Competition.name comp <> "" then begin
          <%s Division.to_string div %> /
          <%s Competition.name comp %>
% end else begin
          <%s Division.to_string div %>
% end;
        <small class="text-muted">
          - <%s! Links.comp ~kind:"secondary" comp "full results" %>
        </small>
        </h3>
        <table class="table">
          <thead>
            <tr>
              <th scope="col"></th>
              <th scope="col">Name</th>
              <th scope="col">Rank</th>
            </tr>
          </thead>
          <tbody>
% State.query_all_where ~p:Id.p ~conv:Results.conv ~st
% {| SELECT * FROM results WHERE competition=? ORDER BY rank ASC LIMIT 3 |}
% (Competition.id comp) ~f:begin fun result ->
% let dancer = Dancer.get st (Results.dancer result) in
            <tr>
              <th>
                <%s Role.short (Results.role result) %>
              </th>
              <th>
                <%s! Links.dancer dancer (Dancer.full_name dancer) %>
              <th>
                <%s Rank.to_string (Results.rank result) %>
              </th>
            </tr>
% end;
          </tbody>
        </table>
      </div> <!-- end of 'Division'/'name' div -->
% end;
% end;
    </div> <!-- end of 'Kind' div -->
% end;
  </div>


let list event_list =

  <h1>Event list</h1>
  <table class="table table-striped my-3">
    <thead>
      <tr>
        <th scope="col">Event Name</th>
        <th scope="col">Month</th>
        <th scope="col">Year</th>
      </tr>
    </thead>
    <tbody>
%   event_list |> List.iter begin fun event ->
      <tr>
        <th scope="row">
          <%s! Links.event event ~kind:"primary" (Event.name event) %>
        </th>
        <td><%s Date.month_name @@ Date.month @@ Event.date event %></td>
        <td><%s string_of_int @@ Date.year @@ Event.date event %></td>
      </tr>
%   end;
    </tbody>
  </table>

