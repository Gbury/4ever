
open Fourever

let dancer_opt st = function
  | None -> Format.asprintf "-"
  | Some r ->
    let dancer = Dancer.get st (Results.dancer r) in
    Links.dancer dancer (Dancer.full_name dancer)

let t st id =
  let event = Event.get st id in

  <h1><%s Event.name event %></h1>
  <h3>
    <%s string_of_int @@ Date.day @@ Event.date event %>
    <%s Date.month_name @@ Date.month @@ Event.date event %> -
    <%s string_of_int @@ Date.year @@ Event.date event %>
  </h3>

  <p>TODO: add some description of events ?</p>

  <div class="container">
% Competition.get_where_event st id
% |> Competition.order_map
% |> Kind.Map.iter begin fun kind map ->
    <div class="row">
      <h2><%s Kind.to_string kind %></h2>
% map |> Division.Map.iter begin fun div l ->
% l |> List.iter begin fun comp ->
      <div class="col-6">
        <h3>
% if Competition.name comp <> "" then begin
          <%s Division.to_string div %> /
          <%s Competition.name comp %>
% end else begin
          <%s Division.to_string div %>
% end;
        <small class="text-muted">
          - <%s! Links.comp ~kind:"secondary" comp "full results" %>
        </small>
        </h3>

        <table class="table table-hover">
          <thead>
            <tr class="table-dark">
              <th scope="col">Leader</th>
              <th scope="col">Rank</th>
              <th scope="col">Follower</th>
            </tr>
          </thead>
          <tbody>
% State.query_list_where ~p:Id.p ~conv:Results.conv ~st
% {| SELECT * FROM results WHERE competition=? AND rank < 100 ORDER BY rank ASC LIMIT 6 |}
% (Competition.id comp) |> Results.order_by_rank |>
% Rank.Map.iter begin fun rank l ->
% begin match rank with
% | Rank.Ranked _ ->
%   Results.iter_by_dancer l begin fun lead follow ->
            <tr class="table-primary">
              <th>
                <%s! dancer_opt st lead %>
              </th>
              <th>
                <%s Rank.to_string rank %>
              </th>
              <th>
                <%s! dancer_opt st follow %>
              </th>
            </tr>
% end;
% | Rank.Reached _ ->
            <tr class="table-active">
              <th></th>
              <th>
                <%s Rank.to_string rank %>
              </th>
              <th></th>
            </tr>
%   Results.iter_by_dancer l begin fun lead follow ->
            <tr class="table-secondary">
              <th>
                <%s! dancer_opt st lead %>
              </th>
              <th>
              </th>
              <th>
                <%s! dancer_opt st follow %>
              </th>
            </tr>
% end;
% end;
% end;
          </tbody>
        </table>
      </div> <!-- end of 'Division'/'name' div -->
% end;
% end;
    </div> <!-- end of 'Kind' div -->
% end;
  </div>


let list event_list =

  <h1>Event list</h1>
  <table class="table table-striped my-3">
    <thead>
      <tr>
        <th scope="col">Event Name</th>
        <th scope="col">Month</th>
        <th scope="col">Year</th>
      </tr>
    </thead>
    <tbody>
%   event_list |> List.iter begin fun event ->
      <tr>
        <th scope="row">
          <%s! Links.event event ~kind:"primary" (Event.name event) %>
        </th>
        <td><%s Date.month_name @@ Date.month @@ Event.date event %></td>
        <td><%s string_of_int @@ Date.year @@ Event.date event %></td>
      </tr>
%   end;
    </tbody>
  </table>

